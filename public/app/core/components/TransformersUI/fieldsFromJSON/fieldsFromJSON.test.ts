import { toDataFrame } from '@grafana/data/src/dataframe/processDataFrame';
import { FieldsFromJSONOptions, fieldsFromJSONTransformer } from './fieldsFromJSON';

describe('Fields from JSON', () => {
  it('adds fields from JSON in string', async () => {
    const cfg: FieldsFromJSONOptions = {
      field: 'line',
      replace: true,
    };
    const data = toDataFrame({
      columns: ['ts', 'line'],
      rows: appl,
    });

    const frames = fieldsFromJSONTransformer.transformer(cfg)([data]);
    expect(frames.length).toEqual(1);
    expect(frames[0].fields.map((v) => v.name)).toMatchInlineSnapshot(`
      Array [
        "a",
        "av",
        "c",
        "e",
        "ev",
        "h",
        "l",
        "o",
        "op",
        "s",
        "sym",
        "v",
        "vw",
        "z",
      ]
    `);
  });
});

const appl = [
  [
    '1636678740000000000',
    '{"a":"148.1673","av":41941752,"c":"148.25","e":1636678800000,"ev":"AM","h":"148.28","l":"148.22","o":"148.25","op":"148.96","s":1636678740000,"sym":"AAPL","v":2903,"vw":"148.2545","z":152}',
  ],
  [
    '1636678680000000000',
    '{"a":"148.1673","av":41938849,"c":"148.25","e":1636678740000,"ev":"AM","h":"148.27","l":"148.25","o":"148.26","op":"148.96","s":1636678680000,"sym":"AAPL","v":7589,"vw":"148.2515","z":329}',
  ],
  [
    '1636678620000000000',
    '{"a":"148.1672","av":41931260,"c":"148.27","e":1636678680000,"ev":"AM","h":"148.27","l":"148.25","o":"148.27","op":"148.96","s":1636678620000,"sym":"AAPL","v":6138,"vw":"148.2541","z":245}',
  ],
  [
    '1636678560000000000',
    '{"a":"148.1672","av":41925122,"c":"148.28","e":1636678620000,"ev":"AM","h":"148.29","l":"148.27","o":"148.27","op":"148.96","s":1636678560000,"sym":"AAPL","v":1367,"vw":"148.2816","z":56}',
  ],
  [
    '1636678500000000000',
    '{"a":"148.1672","av":41923755,"c":"148.25","e":1636678560000,"ev":"AM","h":"148.27","l":"148.25","o":"148.25","op":"148.96","s":1636678500000,"sym":"AAPL","v":556,"vw":"148.2539","z":55}',
  ],
  [
    '1636678440000000000',
    '{"a":"148.1672","av":41923199,"c":"148.28","e":1636678500000,"ev":"AM","h":"148.28","l":"148.25","o":"148.25","op":"148.96","s":1636678440000,"sym":"AAPL","v":451,"vw":"148.2614","z":56}',
  ],
  [
    '1636678380000000000',
    '{"a":"148.1672","av":41922748,"c":"148.24","e":1636678440000,"ev":"AM","h":"148.24","l":"148.24","o":"148.24","op":"148.96","s":1636678380000,"sym":"AAPL","v":344,"vw":"148.2521","z":24}',
  ],
  [
    '1636678320000000000',
    '{"a":"148.1672","av":41922404,"c":"148.28","e":1636678380000,"ev":"AM","h":"148.28","l":"148.24","o":"148.24","op":"148.96","s":1636678320000,"sym":"AAPL","v":705,"vw":"148.2543","z":64}',
  ],
  [
    '1636678260000000000',
    '{"a":"148.1672","av":41921699,"c":"148.25","e":1636678320000,"ev":"AM","h":"148.25","l":"148.25","o":"148.25","op":"148.96","s":1636678260000,"sym":"AAPL","v":1054,"vw":"148.2513","z":131}',
  ],
  [
    '1636678200000000000',
    '{"a":"148.1672","av":41920645,"c":"148.28","e":1636678260000,"ev":"AM","h":"148.28","l":"148.27","o":"148.27","op":"148.96","s":1636678200000,"sym":"AAPL","v":2164,"vw":"148.2756","z":113}',
  ],
  [
    '1636678140000000000',
    '{"a":"148.1672","av":41918481,"c":"148.28","e":1636678200000,"ev":"AM","h":"148.285","l":"148.28","o":"148.285","op":"148.96","s":1636678140000,"sym":"AAPL","v":1800,"vw":"148.2771","z":120}',
  ],
  [
    '1636678080000000000',
    '{"a":"148.1672","av":41916681,"c":"148.28","e":1636678140000,"ev":"AM","h":"148.28","l":"148.2","o":"148.2","op":"148.96","s":1636678080000,"sym":"AAPL","v":2386,"vw":"148.2553","z":108}',
  ],
  [
    '1636678020000000000',
    '{"a":"148.1672","av":41914295,"c":"148.24","e":1636678080000,"ev":"AM","h":"148.24","l":"148.21","o":"148.22","op":"148.96","s":1636678020000,"sym":"AAPL","v":2305,"vw":"148.2265","z":192}',
  ],
  [
    '1636677960000000000',
    '{"a":"148.1672","av":41911990,"c":"148.21","e":1636678020000,"ev":"AM","h":"148.21","l":"148.21","o":"148.21","op":"148.96","s":1636677960000,"sym":"AAPL","v":1525,"vw":"148.2102","z":217}',
  ],
  [
    '1636677900000000000',
    '{"a":"148.1672","av":41910465,"c":"148.22","e":1636677960000,"ev":"AM","h":"148.22","l":"148.21","o":"148.2101","op":"148.96","s":1636677900000,"sym":"AAPL","v":1701,"vw":"148.2114","z":189}',
  ],
  [
    '1636677840000000000',
    '{"a":"148.1672","av":41908764,"c":"148.23","e":1636677900000,"ev":"AM","h":"148.23","l":"148.23","o":"148.23","op":"148.96","s":1636677840000,"sym":"AAPL","v":323,"vw":"148.2263","z":53}',
  ],
  [
    '1636677780000000000',
    '{"a":"148.1672","av":41908441,"c":"148.23","e":1636677840000,"ev":"AM","h":"148.23","l":"148.21","o":"148.21","op":"148.96","s":1636677780000,"sym":"AAPL","v":1371,"vw":"148.2146","z":228}',
  ],
  [
    '1636677660000000000',
    '{"a":"148.1672","av":41907070,"c":"148.2599","e":1636677720000,"ev":"AM","h":"148.2599","l":"148.21","o":"148.25","op":"148.96","s":1636677660000,"sym":"AAPL","v":2512,"vw":"148.2191","z":418}',
  ],
  [
    '1636677600000000000',
    '{"a":"148.1672","av":41904558,"c":"148.25","e":1636677660000,"ev":"AM","h":"148.25","l":"148.24","o":"148.24","op":"148.96","s":1636677600000,"sym":"AAPL","v":6009,"vw":"148.2498","z":2003}',
  ],
  [
    '1636677540000000000',
    '{"a":"148.1672","av":41898549,"c":"148.23","e":1636677600000,"ev":"AM","h":"148.23","l":"148.23","o":"148.23","op":"148.96","s":1636677540000,"sym":"AAPL","v":205,"vw":"148.2275","z":34}',
  ],
  [
    '1636677480000000000',
    '{"a":"148.1672","av":41898344,"c":"148.25","e":1636677540000,"ev":"AM","h":"148.25","l":"148.25","o":"148.25","op":"148.96","s":1636677480000,"sym":"AAPL","v":363,"vw":"148.2506","z":72}',
  ],
  [
    '1636677420000000000',
    '{"a":"148.1672","av":41897981,"c":"148.23","e":1636677480000,"ev":"AM","h":"148.23","l":"148.23","o":"148.23","op":"148.96","s":1636677420000,"sym":"AAPL","v":285,"vw":"148.2412","z":40}',
  ],
  [
    '1636677300000000000',
    '{"a":"148.1672","av":41897595,"c":"148.2","e":1636677360000,"ev":"AM","h":"148.2","l":"148.1999","o":"148.1999","op":"148.96","s":1636677300000,"sym":"AAPL","v":1164,"vw":"148.2005","z":194}',
  ],
  [
    '1636677240000000000',
    '{"a":"148.1672","av":41896431,"c":"148.19","e":1636677300000,"ev":"AM","h":"148.19","l":"148.19","o":"148.19","op":"148.96","s":1636677240000,"sym":"AAPL","v":1566,"vw":"148.1906","z":195}',
  ],
  [
    '1636677180000000000',
    '{"a":"148.1672","av":41894865,"c":"148.21","e":1636677240000,"ev":"AM","h":"148.21","l":"148.21","o":"148.21","op":"148.96","s":1636677180000,"sym":"AAPL","v":499,"vw":"148.1993","z":41}',
  ],
  [
    '1636677120000000000',
    '{"a":"148.1672","av":41894366,"c":"148.17","e":1636677180000,"ev":"AM","h":"148.18","l":"148.17","o":"148.17","op":"148.96","s":1636677120000,"sym":"AAPL","v":717,"vw":"148.1768","z":71}',
  ],
  [
    '1636677000000000000',
    '{"a":"148.1672","av":41893548,"c":"148.19","e":1636677060000,"ev":"AM","h":"148.19","l":"148.19","o":"148.19","op":"148.96","s":1636677000000,"sym":"AAPL","v":1143,"vw":"148.1891","z":142}',
  ],
  [
    '1636676940000000000',
    '{"a":"148.1672","av":41892405,"c":"148.19","e":1636677000000,"ev":"AM","h":"148.19","l":"148.16","o":"148.16","op":"148.96","s":1636676940000,"sym":"AAPL","v":475,"vw":"148.1665","z":59}',
  ],
  [
    '1636676760000000000',
    '{"a":"148.1672","av":41891880,"c":"148.16","e":1636676820000,"ev":"AM","h":"148.16","l":"148.15","o":"148.16","op":"148.96","s":1636676760000,"sym":"AAPL","v":1287,"vw":"148.1573","z":80}',
  ],
  [
    '1636676700000000000',
    '{"a":"148.1672","av":41890593,"c":"148.16","e":1636676760000,"ev":"AM","h":"148.16","l":"148.16","o":"148.16","op":"148.96","s":1636676700000,"sym":"AAPL","v":2395,"vw":"148.1601","z":171}',
  ],
  [
    '1636676640000000000',
    '{"a":"148.1672","av":41888198,"c":"148.19","e":1636676700000,"ev":"AM","h":"148.19","l":"148.19","o":"148.19","op":"148.96","s":1636676640000,"sym":"AAPL","v":798,"vw":"148.1935","z":66}',
  ],
  [
    '1636676580000000000',
    '{"a":"148.1672","av":41887400,"c":"148.21","e":1636676640000,"ev":"AM","h":"148.21","l":"148.21","o":"148.21","op":"148.96","s":1636676580000,"sym":"AAPL","v":223,"vw":"148.2091","z":74}',
  ],
  [
    '1636676520000000000',
    '{"a":"148.1672","av":41887177,"c":"148.25","e":1636676580000,"ev":"AM","h":"148.25","l":"148.25","o":"148.25","op":"148.96","s":1636676520000,"sym":"AAPL","v":570,"vw":"148.2496","z":95}',
  ],
  [
    '1636676460000000000',
    '{"a":"148.1672","av":41886607,"c":"148.2501","e":1636676520000,"ev":"AM","h":"148.2501","l":"148.25","o":"148.25","op":"148.96","s":1636676460000,"sym":"AAPL","v":723,"vw":"148.2555","z":103}',
  ],
  [
    '1636676400000000000',
    '{"a":"148.1672","av":41885884,"c":"148.25","e":1636676460000,"ev":"AM","h":"148.25","l":"148.25","o":"148.25","op":"148.96","s":1636676400000,"sym":"AAPL","v":923,"vw":"148.2459","z":71}',
  ],
  [
    '1636676340000000000',
    '{"a":"148.1672","av":41884961,"c":"148.19","e":1636676400000,"ev":"AM","h":"148.19","l":"148.19","o":"148.19","op":"148.96","s":1636676340000,"sym":"AAPL","v":1501,"vw":"148.1987","z":214}',
  ],
  [
    '1636676220000000000',
    '{"a":"148.1672","av":41883439,"c":"148.2","e":1636676280000,"ev":"AM","h":"148.23","l":"148.18","o":"148.2","op":"148.96","s":1636676220000,"sym":"AAPL","v":9563,"vw":"148.1983","z":531}',
  ],
  [
    '1636676100000000000',
    '{"a":"148.1672","av":41873854,"c":"148.15","e":1636676160000,"ev":"AM","h":"148.18","l":"148.15","o":"148.17","op":"148.96","s":1636676100000,"sym":"AAPL","v":1313,"vw":"148.1677","z":119}',
  ],
  [
    '1636676040000000000',
    '{"a":"148.1672","av":41872541,"c":"148.17","e":1636676100000,"ev":"AM","h":"148.18","l":"148.15","o":"148.15","op":"148.96","s":1636676040000,"sym":"AAPL","v":1472,"vw":"148.1699","z":122}',
  ],
  [
    '1636675980000000000',
    '{"a":"148.1672","av":41871069,"c":"148.15","e":1636676040000,"ev":"AM","h":"148.15","l":"148.13","o":"148.14","op":"148.96","s":1636675980000,"sym":"AAPL","v":1695,"vw":"148.1357","z":113}',
  ],
  [
    '1636675920000000000',
    '{"a":"148.1672","av":41869374,"c":"148.13","e":1636675980000,"ev":"AM","h":"148.13","l":"148.1","o":"148.1","op":"148.96","s":1636675920000,"sym":"AAPL","v":1404,"vw":"148.1101","z":100}',
  ],
  [
    '1636675800000000000',
    '{"a":"148.1672","av":41867864,"c":"148.11","e":1636675860000,"ev":"AM","h":"148.11","l":"148.11","o":"148.11","op":"148.96","s":1636675800000,"sym":"AAPL","v":1002,"vw":"148.11","z":167}',
  ],
  [
    '1636675740000000000',
    '{"a":"148.1672","av":41866862,"c":"148.13","e":1636675800000,"ev":"AM","h":"148.14","l":"148.13","o":"148.14","op":"148.96","s":1636675740000,"sym":"AAPL","v":262,"vw":"148.1268","z":52}',
  ],
  [
    '1636675680000000000',
    '{"a":"148.1672","av":41866600,"c":"148.14","e":1636675740000,"ev":"AM","h":"148.14","l":"148.12","o":"148.12","op":"148.96","s":1636675680000,"sym":"AAPL","v":1822,"vw":"148.13","z":121}',
  ],
  [
    '1636675620000000000',
    '{"a":"148.1672","av":41864778,"c":"148.12","e":1636675680000,"ev":"AM","h":"148.12","l":"148.09","o":"148.09","op":"148.96","s":1636675620000,"sym":"AAPL","v":1392,"vw":"148.1015","z":126}',
  ],
  [
    '1636675560000000000',
    '{"a":"148.1672","av":41863386,"c":"148.09","e":1636675620000,"ev":"AM","h":"148.09","l":"148.08","o":"148.09","op":"148.96","s":1636675560000,"sym":"AAPL","v":513,"vw":"148.0876","z":64}',
  ],
  [
    '1636675500000000000',
    '{"a":"148.1672","av":41862873,"c":"148.06","e":1636675560000,"ev":"AM","h":"148.06","l":"148.06","o":"148.06","op":"148.96","s":1636675500000,"sym":"AAPL","v":650,"vw":"148.06","z":650}',
  ],
  [
    '1636675440000000000',
    '{"a":"148.1672","av":41862223,"c":"148.09","e":1636675500000,"ev":"AM","h":"148.1","l":"148.06","o":"148.06","op":"148.96","s":1636675440000,"sym":"AAPL","v":11092,"vw":"148.0812","z":504}',
  ],
  [
    '1636675380000000000',
    '{"a":"148.1672","av":41851131,"c":"148.06","e":1636675440000,"ev":"AM","h":"148.06","l":"148.06","o":"148.06","op":"148.96","s":1636675380000,"sym":"AAPL","v":893,"vw":"148.0595","z":59}',
  ],
  [
    '1636675320000000000',
    '{"a":"148.1672","av":41850238,"c":"148.05","e":1636675380000,"ev":"AM","h":"148.05","l":"148.05","o":"148.05","op":"148.96","s":1636675320000,"sym":"AAPL","v":437,"vw":"148.0565","z":39}',
  ],
  [
    '1636675260000000000',
    '{"a":"148.1672","av":41849801,"c":"148.06","e":1636675320000,"ev":"AM","h":"148.06","l":"148.06","o":"148.06","op":"148.96","s":1636675260000,"sym":"AAPL","v":2059,"vw":"148.06","z":93}',
  ],
  [
    '1636675200000000000',
    '{"a":"148.1672","av":41847742,"c":"148.06","e":1636675260000,"ev":"AM","h":"148.06","l":"148.05","o":"148.05","op":"148.96","s":1636675200000,"sym":"AAPL","v":928,"vw":"148.0538","z":71}',
  ],
  [
    '1636675080000000000',
    '{"a":"148.1672","av":41846755,"c":"148.03","e":1636675140000,"ev":"AM","h":"148.03","l":"148.03","o":"148.03","op":"148.96","s":1636675080000,"sym":"AAPL","v":124,"vw":"148.0291","z":24}',
  ],
  [
    '1636675020000000000',
    '{"a":"148.1672","av":41846631,"c":"148.03","e":1636675080000,"ev":"AM","h":"148.03","l":"148.0101","o":"148.0101","op":"148.96","s":1636675020000,"sym":"AAPL","v":430,"vw":"148.0166","z":107}',
  ],
  [
    '1636674960000000000',
    '{"a":"148.1672","av":41846201,"c":"148.02","e":1636675020000,"ev":"AM","h":"148.02","l":"148.02","o":"148.02","op":"148.96","s":1636674960000,"sym":"AAPL","v":117,"vw":"148.0202","z":29}',
  ],
  [
    '1636674900000000000',
    '{"a":"148.1672","av":41846084,"c":"148.04","e":1636674960000,"ev":"AM","h":"148.04","l":"148.04","o":"148.04","op":"148.96","s":1636674900000,"sym":"AAPL","v":302,"vw":"148.0397","z":151}',
  ],
  [
    '1636674840000000000',
    '{"a":"148.1672","av":41845782,"c":148,"e":1636674900000,"ev":"AM","h":"148.01","l":148,"o":"148.01","op":"148.96","s":1636674840000,"sym":"AAPL","v":2056,"vw":"148.0033","z":137}',
  ],
  [
    '1636674720000000000',
    '{"a":"148.1672","av":41843678,"c":"148.05","e":1636674780000,"ev":"AM","h":"148.05","l":"148.05","o":"148.05","op":"148.96","s":1636674720000,"sym":"AAPL","v":461,"vw":"148.0513","z":92}',
  ],
  [
    '1636674660000000000',
    '{"a":"148.1672","av":41843217,"c":"148.05","e":1636674720000,"ev":"AM","h":"148.05","l":"148.05","o":"148.05","op":"148.96","s":1636674660000,"sym":"AAPL","v":487,"vw":"148.0494","z":69}',
  ],
];
