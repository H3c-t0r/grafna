/* v2.52 Copyright 2015 AdRem Software, all rights reserved */
!function(e,t){"use strict";"function"==typeof define&&define.amd?define("remoteDataLists",["client"],function(e){return t(e),e.RemoteDataListStore}):t(e.adrem)}("undefined"==typeof window?global:window,function(e){"use strict";!function(e){var t=0,i=1,s=2,n="debug",r="work",h=function(e){return Array.isArray(e)?e:[e]},a=function(e,t,i,s){var r,h,a,o;if(e===n)t.fields.forEach(function(e,t){var n=i[e.FieldName];void 0!==n&&(s[t]=n)});else if("R"===i[0])for(r=t.fields.length,h=0;r>h;h++)s[h]=i[h+1];else if("C"===i[0])for(r=i.length,h=1;r>h;)a=i[h++],o=i[h++],s[a]=o},o=function(e,t,i){var s,r,h,a=t.keyIx;if(e===n)return i[t.key];if("R"===i[0])return i[a+1];for(s=i.length-1;s>0;)if(h=i[s--],r=i[s--],r===a)return h;return null},d=function(t,i){var s={},n={},r=function(e){return function(){var t=n[e];return void 0===t&&(t=s[e]),t}},h=function(e){return function(i){n[e]=i,t.fireEvent("property-changed",{name:e,value:i})}};this.getChanges=function(){return n},this.clearChanges=function(){e.extend(s,n),n={}},this.getValues=function(){return s},this.update=function(e){for(var i in e)e.hasOwnProperty(i)&&s[i]!==e[i]&&(s[i]=e[i],this.hasOwnProperty(i)||Object.defineProperty(this,i,{get:r(i),set:h(i),configurable:!0,enumerable:!0}),t.fireEvent("property-changed",{name:i,value:s[i]}));n={}},this.isChanged=function(){var e;for(e in n)if(n.hasOwnProperty(e))return!0;return!1},this.update(i)},f=function(e){function t(e){var t=this._owner_._private_;return void 0!==t.changes[e]?t.changes[e]:t.values[e]}function i(e,t){var i=this._owner_._private_;i.changes[e]=t,this._owner_.touch(),i.model.notifyRecChanged(this._owner_)}function s(e){return function(){return t.call(this,e)}}function n(e){return function(t){return i.call(this,e,t)}}e.fields.forEach(function(e,t){Object.defineProperty(this,e.FieldName,{set:n(t),get:s(t),configurable:!0,enumerable:!0})},this),this.getByIndex=function(e){return t.call(this,e)}},u=function(e){var t=function(e){Object.defineProperty(this,"_owner_",{value:e,configurable:!0})};return t.prototype=new f(e),t},l=function(){var t=function(e,t,i){var s,r,h;if(Object.defineProperty(this,"_private_",{value:{}}),h=this._private_,h.values=[],h.changes=[],h.model=e,this.values=new e.DataListValues(this),this.local={},r=this._private_.model.fields,t===n)for(s=r.length-1;s>=0;s--)h.values[s]=i[r[s].FieldName],h.changes[s]=void 0;else this.update(t,i);h.key=h.values[this._private_.model.keyIx],void 0!==this.getKey()?(h.changed=h.model.getChangeStamp(),h.serverRev=h.changed):this.touch()};return e.extend(t.prototype,{getKey:function(){return this._private_.key},unlink:function(){Object.defineProperty(this,"_owner_",{value:void 0}),delete this.values},setKey:function(e){if(void 0!==this._private_.key)throw new Error("Invalid attempt to change record key.");this._private_.values[this._private_.model.keyIx]=e,this._private_.key=e},hasKey:function(){return void 0!==this._private_.key},isChanged:function(e){return void 0===e&&(e=this._private_.serverRev||0),this._private_.changed>e},getValues:function(){var e,t,i,s={};for(t=this._private_.model.fields,e=t.length-1;e>=0;e--)i=t[e].FieldName,s[i]=this.values[i];return s},getChanges:function(){var e={},t=this.getKey();return e[this._private_.model.key]=t,this._private_.model.fields.forEach(function(i,s){void 0!==this._private_.changes[s]?e[i.FieldName]=this._private_.changes[s]:void 0===t&&(e[i.FieldName]=this._private_.values[s])},this),e},clearChanges:function(){var e;if(this._private_.changed>this._private_.serverRev){for(e=this._private_.changes.length-1;e>=0;e--)this._private_.changes[e]=void 0;this._private_.changed=this._private_.serverRev}},remove:function(){this._private_.model.owner.delByRec(this)},update:function(e,t){a(e,this._private_.model,t,this._private_.values),this.clearChanges(),this._private_.serverRev=this._private_.model.getChangeStamp(),this._private_.changed=this._private_.serverRev},touch:function(){this._private_.changed=this._private_.model.getChangeStamp()}}),t}(),c=function(){function t(t,i){e.extend(this,i),this.owner=t,this.keyIx=-1,this.changeRevision=0,this.DataListValues=new u(this),this.fields.some(function(e,t){return e.FieldName===this.key?(this.keyIx=t,!0):!1},this)}return e.extend(t.prototype,{finalize:function(){delete this.DataListValues},newRecord:function(e,t){return new l(this,e,t)},getChangeStamp:function(){return this.changeRevision+=1,this.changeRevision},notifyRecChanged:function(e){this.owner.notifyChanged(e)}}),t}(),p=function(){function a(e){e.eventid===t?this.needsRefresh=!0:e.eventid===i?this.needsRefreshProperties=!0:e.eventid===s&&(this.fastRefresh=!1,this.doRefresh(e.data)),this.fastRefresh&&(this.fastRefresh=!1,this.refresh())}var f=function(t,i){function s(){(h.needsRefresh||h.needsRefreshProperties)&&h.refresh(),h.commitProperties(),setTimeout(s,h.minRefreshTime)}var h=this;this.map={},this.data=[],this.deleted=[],this.minRefreshTime=void 0!==i?i:250,this.needsRefresh=!1,this.fastRefresh=!1,this.needsRefreshProperties=!1,this.updating=0,this.suppressedChangedNotification=!1,this.propertyupdating=!1,this.dataEncoding=e.debug?n:r,this.properties={beginUpdate:function(){h.propertyupdating=!0},endUpdate:function(){h.propertyupdating=!1}},this.remoteData=new e[t].IDataListStore({dataFormat:this.dataEncoding}),e.Client.on(this.remoteData.id,a,this),f.inherited.constructor.call(this),s()};return e.inherit(f,e.EventManager),e.extend(f.prototype,{deleteProperties:function(){Object.keys(this.properties).forEach(function(e){delete this.properties[e]},this)},finalize:function(){e.Client.un(this.remoteData.id,a,this),this.remoteData&&this.remoteData.destroy(),delete this.remoteData,this.deleteProperties(),void 0!==this.model&&(this.model.finalize(),delete this.model)},notifyChanged:function(e){0===this.updating?(void 0!==e&&this.fireEvent("record-changed",e),this.fireEvent("changed")):this.suppressedChangedNotification=!0},notifyDeleted:function(e){0===this.updating?(this.fireEvent("record-deleted",e),this.fireEvent("changed")):this.deleted.indexOf(e)<0&&this.suppressedDeletes.push(e)},perform:function(){return this.remoteData.perform.apply(this,Array.prototype.slice.call(arguments,0))},asyncPerform:function(){return this.remoteData.perform.asTask.apply(this,Array.prototype.slice.call(arguments,0))},beginUpdate:function(){0===this.updating&&(this.suppressedChangedNotification=!1,this.suppressedDeletes=[],null!=this.model&&(this.updateRevision=this.model.getChangeStamp()-1)),this.updating+=1},endUpdate:function(e){var t=[],i=[];this.updating-=1,0!==this.updating||!this.suppressedChangedNotification&&e!==!0||(this.hasListener("record-changed")&&(t=this.data.filter(function(e){return e.isChanged(this.updateRevision)},this)),this.hasListener("record-deleted")&&(i=this.deleted.filter(function(e){return e._private_.deleted>this.updateRevision},this),i=i.concat(this.suppressedDeletes),this.suppressedDeletes=[]),t.length>0?this.notifyChanged(t):this.notifyChanged(),i.length>0&&(this.notifyDeleted(i),i.forEach(function(e){void 0!==e.unlink&&e.unlink()}),i=[]))},destroy:function(){this.close(),this.finalize()},close:function(e){e=null!=e?e:!0,void 0!==this.model&&(this.model.finalize(),delete this.model),e&&null!=this.remoteData&&this.remoteData.close(),this.deleteProperties(),this.data=[],this.map={}},open:function(e,t,i,s){t=t||"",this.close(!1),this.tableName=e,this.remoteData.open(e,t,function(e){null!=e.fields&&(this.model=new c(this,e)),s=s||this,this.readProperties(!0)},this),this.needsRefresh=!0,this.refresh(function(){void 0!==i&&i.call(s,this.data),this.fireEvent("open",this),this.notifyChanged()})},getValues:function(){return this.data.map(function(e){return e.getValues()},this)},getByKey:function(e){return this.map[e]},delByIndex:function(e,t){var i,s;if(e<this.data.length)for(s=e+t,s>=this.data.length&&(s=this.data.length-1),i=s;i>=e;i-=1)this.delByRec(this.data[i])},delByRec:function(e,t){var i;void 0===t&&(t=!1),void 0!==e&&(i=e.getKey(),delete this.map[i],this.data.splice(this.data.indexOf(e),1),void 0===i||t||(e._private_.deleted=this.model.getChangeStamp(),this.deleted.push(e)),this.notifyDeleted(e),this.notifyChanged())},delByKey:function(e){void 0!==e&&this.delByRec(this.map[e])},addRecord:function(e){return this.data.push(e),void 0!==e.getKey()&&(this.map[e.getKey()]=e),this.notifyChanged(e),e},add:function(e){return this.addRecord(this.model.newRecord(this.dataEncoding,e))},clear:function(){this.revert(),this.remoteData.clear(function(){var e=this.data;this.data=[],this.map=[],this.deleted=[],e.length>0&&(this.notifyDeleted(e),this.notifyChanged()),this.fireEvent("clear",this)},this)},readProperties:function(e){e&&null!=this.remoteData&&(this.needsRefreshProperties=!1,this.remoteData.getProperties(function(e){e.forEach(function(e){this.properties.hasOwnProperty(e.group)?this.properties[e.group].update(e.properties):this.properties[e.group]=new d(this,e.properties),this.fireEvent("property-group-changed",e.group,this.properties[e.group])},this)},this))},commitProperties:function(){var e,t,i=[];if(this.propertyupdating===!1){for(t in this.properties)this.properties.hasOwnProperty(t)&&(e=this.properties[t],void 0!==e.isChanged&&e.isChanged()&&(i.push({group:t,properties:e.getChanges()}),e.clearChanges()));i.length>0&&this.remoteData.setProperties(i)}},refresh:function(e){this.readProperties(this.needsRefreshProperties),this.needsRefresh?(this.needsRefresh=!1,null!=this.remoteData&&this.remoteData.refresh(function(t){this.doRefresh(t),void 0!==e&&e.call(this)},this)):this.fastRefresh=!0},internalDoRefresh:function(e){var t,i,s,n,r,h,a,d={},f=[];if(e.reload&&(this.data=[],this.map={}),this.deleted.length>0&&this.deleted.forEach(function(e,t){d[e.getKey()]=t},this),void 0!==e.updates&&null!=this.model)for(s=Array.isArray(e.updates)?e.updates:[e.updates],t=s.length-1;t>=0;t--)r=s[t],n=o(this.dataEncoding,this.model,r),h=this.map[n],void 0!==h?(h.update(this.dataEncoding,r),this.notifyChanged(h)):(i=d[n],void 0!==i?this.deleted[i].update(this.dataEncoding,r):this.add(r));if(void 0!==e.deletes)for(s=Array.isArray(e.deletes)?e.deletes:[e.deletes],t=s.length-1;t>=0;t--)n=s[t],a=this.map[n],void 0!==a?this.delByRec(this.map[n],!0):(i=d[n],void 0!==i&&f.push(i)),f.length>0&&(f.sort(function(e,t){return t-e}),f.forEach(function(e){this.deleted.splice(e,1)},this))},doRefresh:function(e){if(e.success){this.beginUpdate(),null!=e.fields&&(this.model=new c(this,{key:e.key,fields:e.fields}));try{this.internalDoRefresh(e)}finally{this.endUpdate(!0),null!=e.markers&&h(e.markers).forEach(function(e){this.fireEvent("change-marker",e)},this)}}},commit:function(){var e,t,i=[];e=this.data.filter(function(e){return e.isChanged()?(i.push(e.getChanges()),!0):!1},this),t=this.deleted.map(function(e){return e.getKey()},this),this.deleted=[],t.length>0&&this.remoteData.remove(t),i.length>0&&this.remoteData.update(i,function(t){t=h(t),e.forEach(function(e,i){i<t.length&&void 0===e.getKey()&&(e.setKey(t[i]),this.map[t[i]]=e)},this)},this),this.fireEvent("commit",this),this.refresh()},revert:function(){var e;for(e=this.data.length-1;e>=0;e--)void 0===this.data[e].getKey()?this.data.splice(e,1):this.data[e].isChanged()&&this.data[e].clearChanges();this.deleted.forEach(function(e){e.isChanged()&&e.clearChanges(),this.addRecord(e)},this),this.deleted=[],this.fireEvent("revert",this),this.notifyChanged()}}),f}();e.RemoteDataListStore=p,"object"==typeof module&&(module.exports=p)}(e)});