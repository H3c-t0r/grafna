kind: pipeline
type: docker
name: Test PR
trigger:
  event:
    - pull_request
steps:
  # Install various dependencies
  - name: install-deps
    image: grafana/build-container:1.2.20
    environment:
      GRABPL_VERSION: "0.4.12"
    commands:
      - apt-get update
      - curl -fLO https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v$${GRABPL_VERSION}/grabpl
      - chmod +x grabpl
      - mkdir -p bin
      - mv grabpl bin
  - name: lint-go
    image: grafana/build-container:1.2.20
    environment:
      # we need CGO because of go-sqlite3
      CGO_ENABLED: 1
    depends_on:
      - install-deps
    commands:
      - mkdir -p tmp
      - cd tmp
      - curl -fLO https://github.com/golangci/golangci-lint/releases/download/v1.24.0/golangci-lint-1.24.0-linux-amd64.tar.gz
      - echo 241ca454102e909de04957ff8a5754c757cefa255758b3e1fba8a4533d19d179 \
          golangci-lint-1.24.0-linux-amd64.tar.gz | sha256sum --check --strict --status
      - tar -xf golangci-lint-1.24.0-linux-amd64.tar.gz
      - mv golangci-lint-1.24.0-linux-amd64/golangci-lint /usr/local/bin/
      - cd ..
      - rm -rf tmp
      - make scripts/go/bin/revive scripts/go/bin/gosec
      - go vet ./pkg/...
      - |
        golangci-lint run -v -j 4 --config scripts/go/configs/ci/.golangci.yml -E deadcode -E gofmt \
          -E gosimple -E ineffassign -E structcheck -E typecheck ./pkg/...
      - |
        golangci-lint run -v -j 4 --config scripts/go/configs/ci/.golangci.yml -E unconvert -E unused \
          -E varcheck -E goconst -E errcheck -E staticcheck ./pkg/...
      - ./scripts/go/bin/revive -formatter stylish -config ./scripts/go/configs/revive.toml ./pkg/...
      - |
        ./scripts/go/bin/revive -formatter stylish -config ./scripts/go/configs/revive-strict.toml \
          -exclude ./pkg/plugins/backendplugin/pluginextensionv2/... \
          ./pkg/services/alerting/... \
          ./pkg/services/provisioning/datasources/... \
          ./pkg/services/provisioning/dashboards/... \
          ./pkg/plugins/backendplugin/...
      - |
        ./scripts/go/bin/gosec -quiet -exclude=G104,G107,G108,G201,G202,G204,G301,G304,G401,G402,G501 \
          -conf=./scripts/go/configs/gosec.json ./pkg/...
  - name: codespell
    image: grafana/build-container:1.2.20
    depends_on:
      - install-deps
    commands:
      - apt-get install -y python-pip
      - pip install codespell
      # Important: all words have to be in lowercase, and separated by "\n".
      - 'echo -e "unknwon\nreferer\nerrorstring\neror\niam" > words_to_ignore.txt'
      - codespell -I words_to_ignore.txt docs/
  - name: shellcheck
    image: grafana/build-container:1.2.20
    depends_on:
      - install-deps
    environment:
      VERSION: "0.7.1"
      CHKSUM: beca3d7819a6bdcfbd044576df4fc284053b48f468b2f03428fe66f4ceb2c05d9b5411357fa15003cb0311406c255084cf7283a3b8fce644c340c2f6aa910b9f
    commands:
      - curl -fLO http://storage.googleapis.com/grafana-downloads/ci-dependencies/shellcheck-v$${VERSION}.linux.x86_64.tar.xz
      - echo $$CHKSUM shellcheck-v$${VERSION}.linux.x86_64.tar.xz | sha512sum --check --strict --status
      - tar xf shellcheck-v$${VERSION}.linux.x86_64.tar.xz
      - mv shellcheck-v$${VERSION}/shellcheck /usr/local/bin/
      - ./bin/grabpl shellcheck
  - name: build-oss-backend
    image: grafana/build-container:1.2.20
    depends_on:
      - install-deps
      - lint-go
    commands:
      - "echo Building '${DRONE_BUILD_NUMBER}'"
      - ./bin/grabpl build-backend --github-token "${GITHUB_GRAFANABOT_TOKEN}" --edition oss --build-id $DRONE_BUILD_NUMBER
  - name: test-backend
    image: grafana/build-container:1.2.20
    depends_on:
      - install-deps
      - lint-go
    commands:
      - go test -tags=integration -covermode=atomic ./pkg/...
  - name: build-oss-frontend
    image: grafana/build-container:1.2.20
    depends_on:
      - install-deps
    commands:
      - yarn install --frozen-lockfile --no-progress
      - ./bin/grabpl build-frontend --no-install-deps --github-token "${GITHUB_GRAFANABOT_TOKEN}" --edition oss --build-id $DRONE_BUILD_NUMBER
