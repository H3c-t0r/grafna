#!/bin/bash

. e2e/variables

echo -e "Starting Grafana Server E2E Scenario"

./e2e/kill-server

mkdir $RUNDIR

echo -e "Copying grafana backend files to temp dir..."

if [ -f dist/grafana-latest.linux-x64.tar.gz ]; then
  echo "Found built tar file"
  tar zxf dist/grafana-latest.linux-x64.tar.gz -C $RUNDIR
  mv $RUNDIR/grafana-*/* $RUNDIR
  ls $RUNDIR/public/views
else
  echo "Copying local dev files"

  cp -r ./bin $RUNDIR
  cp -r ./public $RUNDIR

  mkdir $RUNDIR/conf
  cp ./conf/defaults.ini $RUNDIR/conf/defaults.ini
  cp ./conf/sample.ini $RUNDIR/conf/custom.ini
fi

$RUNDIR/bin/grafana-server \
  --homepath=$RUNDIR \
  --pidfile=$RUNDIR/pid \
  cfg:server.http_port=$PORT \
  cfg:log.level=debug \
  2>&1 > $RUNDIR/output.log &

